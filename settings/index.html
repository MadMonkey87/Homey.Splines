<html>

<head>
    <script type="text/javascript" src="/homey.js" data-origin="settings"></script>
    <!--<script src='https://cdn.staticaly.com/gh/robertklep/homey-mocks/v0.0.4/homey-settings-mock.js'></script>-->
    <!--<script src="js/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
        <script src="js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>-->

    <!--<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
        integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/0.5.7/chartjs-plugin-annotation.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-plugin-dragdata@latest/dist/chartjs-plugin-dragdata.min.js"></script>
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/animation.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/bootstrap-slider.min.js"></script>
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/css/bootstrap-slider.min.css">-->

    <script src="js/jquery-3.5.1.slim.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/Chart.min.js"></script>
    <script src="js/chartjs-plugin-annotation.min.js"></script>
    <script src="js/chartjs-plugin-dragdata.min.js"></script>
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/animation.css">
    <link rel="stylesheet" href="css/font-awesome.min.css">

    <script src="js/bootstrap-slider.min.js"></script>
    <link rel="stylesheet" href="css/bootstrap-slider.min.css">

</head>

<body>

    <div class="homeyAnimation"></div>

    <nav>
        <div class="nav nav-tabs glass-dark" id="nav-tab" role="tablist"
            style="margin-left: 5px; margin-top: 5px; margin-right: 5px;">
            <a class="nav-item nav-link active" id="nav-splines-tab" data-toggle="tab" href="#nav-splines" role="tab"
                aria-controls="nav-splines" aria-selected="true"
                style="border-top-left-radius: 3px; border-bottom-left-radius: 3px;">Splines</a>
            <a class="nav-item nav-link" id="nav-about-tab" data-toggle="tab" href="#nav-about" role="tab"
                aria-controls="nav-contact" aria-selected="false">About</a>
        </div>
    </nav>
    <div class="tab-content" id="nav-tabContent">
        <div class="tab-pane fade show active" id="nav-splines" role="tabpanel" aria-labelledby="nav-splines-tab">


            <!-- spline modal  begin-->
            <div class="modal fade" id="createSplineModal" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Spline</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">

                            <div class="row">
                                <div class="col-sm">
                                    <div class="form-group">
                                        <label>Name</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="splineName">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-6">
                                    <div class="form-group">
                                        <label>Min X</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="minx">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form-group">
                                        <label>Max X</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="maxx">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <div class="form-group">
                                        <label>Min Y</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="miny">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="form-group">
                                        <label>Max Y</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="maxy">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <div class="form-group">
                                        <label>Round results to digits (0-4)</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="round" min=0 max=4>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-sm">
                                    <button type="button" class="btn btn-primary float-right" id="addVertexButton"
                                        style="width: 42px !important; height: 42px !important">
                                        <span class="fa fa-plus"></span>
                                    </button>
                                    <canvas id="chart" width="400" height="400">
                                    </canvas>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-sm">
                                    <div class="form-group">
                                        <label>Live testing</label>
                                        <p style="font-style: italic;">Use the slider bellow to trigger the related flow
                                            cards and test the spline in real time. Click the button to trigger the
                                            testing again at the given posistion.</p>
                                        <div class="input-group">
                                            <input type="text" id="livetesting" style="width: 100%;">
                                        </div>
                                        <button type="button" class="btn btn-primary float-right" id="livetestingbutton"
                                            style="width: 42px !important; height: 42px !important">
                                            <span class="fa fa-refresh"></span>
                                        </button>
                                    </div>


                                </div>
                            </div>



                            <ul class="list-group list-group-flush" id="splineVertices">
                            </ul>

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" data-dismiss="modal"
                                id="newSplineSaveButton">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!--spline modal end-->

            <!--splines tab begin-->
            <div class="card glass" style="margin-top: 10px;">




                <div class="card-body">

                    <div class="loading" id="loading">
                        <div class="sk-cube-grid">
                            <div class="sk-cube sk-cube1"></div>
                            <div class="sk-cube sk-cube2"></div>
                            <div class="sk-cube sk-cube3"></div>
                            <div class="sk-cube sk-cube4"></div>
                            <div class="sk-cube sk-cube5"></div>
                            <div class="sk-cube sk-cube6"></div>
                            <div class="sk-cube sk-cube7"></div>
                            <div class="sk-cube sk-cube8"></div>
                            <div class="sk-cube sk-cube9"></div>
                        </div>
                    </div>

                    <p class="card-text">Create and edit your splines here and use them in your flow cards afterwards.
                    </p>

                    <div class="row">
                        <div class="col-sm">
                            <button type="button" class="btn btn-primary float-right" id="createSplineModalButton"
                                style="width: 125px;" data-toggle="modal"
                                data-target="#createSplineModal">Create</button>
                        </div>
                    </div>
                    <br>

                    <ul class="list-group list-group-flush" id="splineCollection">
                    </ul>
                </div>
            </div>
            <!--splines tab end-->

        </div>

        <div class="tab-pane fade" id="nav-about" role="tabpanel" aria-labelledby="nav-about-tab">

            <!--about tab begin-->
            <div class="card glass" style="margin-top: 10px;">
                <div class="card-body">
                    <img class="card-img-top" src="images/icon.svg"
                        style="padding-left: 20%; padding-right: 20%; padding-top: 35px;padding-bottom: 15px;">
                    <div class="sk-cube-grid" style="margin:10% auto">
                        <div class="sk-cube sk-cube1"></div>
                        <div class="sk-cube sk-cube2"></div>
                        <div class="sk-cube sk-cube3"></div>
                        <div class="sk-cube sk-cube4"></div>
                        <div class="sk-cube sk-cube5"></div>
                        <div class="sk-cube sk-cube6"></div>
                        <div class="sk-cube sk-cube7"></div>
                        <div class="sk-cube sk-cube8"></div>
                        <div class="sk-cube sk-cube9"></div>
                    </div>
                    <h5 class="card-title">Splines for Homey v2.0.0</h5>
                    <h3 class="card-title">© Philippe Wechsler 2021</h3>
                    <div>Icons made by <a href="https://www.flaticon.com/authors/freepik" title="Freepik">Freepik</a>
                        from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></div>
                </div>
            </div>

            <!--about tab end-->
        </div>
    </div>

    <script type="text/javascript">

        function onHomeyReady(Homey) {

            const loading = document.getElementById('loading');

            if (Homey.isMock) {
                Homey.alert('Warning: Homey is mocked only!!!');
            }

            // splines main

            let splines = [];

            function renderSplines() {
                let collectionMarkup = '';
                for (var i = 0; i < splines.length; i++) {
                    collectionMarkup += `
                        <li class="list-group-item transparent">
                            <div class="form-group">
                                <label style="font-weight: bold; font-size: 18px; margin-top: 5px">${splines[i].name}</label>
                                <div class="btn-group float-right" style="margin-bottom: 5px" >
                                    <button type="button" class="btn btn-primary" style="margin-top: 5px; height: 42px !important; width: 42px !important" data-toggle="modal" data-target="#createSplineModal" onclick="editSpline(${i})"><span
                                            class="fa fa-edit"></span></button>
                                    <button type="button" class="btn btn-secondary" style="margin-top: 5px; height: 42px !important; width: 42px !important" onclick="duplicateSpline(${i})"><span
                                            class="fa fa-clone"></span></button>
                                    <button type="button" class="btn btn-secondary" style="margin-top: 5px; height: 42px !important; width: 42px !important" onclick="removeSpline(${i})"><span
                                            class="fa fa-trash"></span></button>
                                </div>
                            </div>
                        </li>
                    `;
                }

                document.getElementById('splineCollection').innerHTML = collectionMarkup;
                loading.style.display = 'none';
            }

            window.removeSpline = function (e) {
                Homey.confirm('Do you want to delete the spline?', 'warning', (e1, e2) => {
                    if (e2 === true) {
                        loading.style.display = 'initial';
                        splines.splice(e, 1);
                        persistSplines();
                    }
                });
            }

            window.editSpline = function (e) {
                this.selectedSpline = { ...splines[e], vertices: [...splines[e].vertices] };
                renderSelectedSpline();
            }

            window.duplicateSpline = function (e) {
                loading.style.display = 'initial';
                const newSpline = { ...splines[e], vertices: [...splines[e].vertices], name: splines[e].name + ' Copy', id: generateGuid() };
                splines.push(newSpline);
                persistSplines();
            }

            persistSplines = function () {
                Homey.set('splines', splines, (err, result) => {
                    if (err) return Homey.alert(err);
                    loadSplines();
                });
            }

            // create/edit spline dialog

            let selectedSpline = {};

            document.getElementById('newSplineSaveButton').addEventListener('click', (e) => {
                if (this.selectedSpline.id == null) {
                    this.selectedSpline.id = generateGuid();
                    splines.push(this.selectedSpline);
                } else {
                    for (var i = 0; i < splines.length; i++) {
                        if (splines[i].id === this.selectedSpline.id) {
                            splines[i] = this.selectedSpline;
                            break;
                        }
                    }
                }
                renderSplines();
                persistSplines();
            });

            document.getElementById('createSplineModalButton').addEventListener('click', (e) => {
                this.selectedSpline = { name: 'New Spline', vertices: [{ x: 0, y: 0 }, { x: 50, y: 20 }, { x: 100, y: 0 }], id: null, minx: 0, miny: 0, maxx: 100, maxy: 25, digits: 2 };
                slider.setValue(0);
                renderSelectedSpline();
            });

            document.getElementById('splineName').addEventListener('blur', (e) => { updateVertexForm(); renderSelectedSpline(); });
            document.getElementById('minx').addEventListener('blur', (e) => { updateBoundaries(); });
            document.getElementById('miny').addEventListener('blur', (e) => { updateBoundaries(); });
            document.getElementById('maxx').addEventListener('blur', (e) => { updateBoundaries(); });
            document.getElementById('maxy').addEventListener('blur', (e) => { updateBoundaries(); });
            document.getElementById('round').addEventListener('blur', (e) => { updateVertexForm(); updateBoundaries(); });
            document.getElementById('addVertexButton').addEventListener('click', (e) => { addVertex(); });

            var slider = new Slider('#livetesting', {
                min: "0",
                max: "100",
                step: "0.1",
                value: 0,
                tooltip: "hide"
            });
            slider.on("slideStop", function (sliderValue) {
                liveTest(sliderValue);
            });
            slider.on("slide", function (sliderValue) {
                chart.options.annotation.annotations[0].value = sliderValue / 100 * (this.selectedSpline.maxx - this.selectedSpline.minx);
                chart.options.annotation.annotations[0].borderColor = 'rgba(108, 117, 125,0.35)';
                chart.options.annotation.annotations[0].label.content = (sliderValue / 100 * (this.selectedSpline.maxx - this.selectedSpline.minx)).toFixed(2);
                chart.update();
            });
            document.getElementById('livetestingbutton').addEventListener('click', (e) => {
                chart.options.annotation.annotations[0].borderColor = 'rgba(108, 117, 125,0.35)';
                chart.update();
                liveTest(slider.getValue());
            });

            function addVertex(x, y) {
                if (!x) {
                    x = (this.selectedSpline.maxx - this.selectedSpline.minx) / 2;
                }
                if (!y) {
                    y = (this.selectedSpline.maxy - this.selectedSpline.miny) / 2;
                }
                this.selectedSpline.vertices.push({ x: x, y: y });
                sortVertices();
                renderSelectedSpline();
            }

            function sortVertices() {
                this.selectedSpline.vertices.sort((a, b) => {
                    if (a.x < b.x) {
                        return -1;
                    }
                    if (a.x > b.x) {
                        return 1;
                    }
                    return 0;
                });
            }

            function updateBoundaries() {
                const minx = parseInt(document.getElementById('minx').value);
                const maxx = parseInt(document.getElementById('maxx').value);
                const miny = parseInt(document.getElementById('miny').value);
                const maxy = parseInt(document.getElementById('maxy').value);

                if (minx < maxx && miny < maxy) {
                    this.selectedSpline.minx = parseInt(document.getElementById('minx').value);
                    this.selectedSpline.maxx = parseInt(document.getElementById('maxx').value);
                    this.selectedSpline.miny = parseInt(document.getElementById('miny').value);
                    this.selectedSpline.maxy = parseInt(document.getElementById('maxy').value);
                }

                this.selectedSpline.vertices[0].x = this.selectedSpline.minx;
                this.selectedSpline.vertices[this.selectedSpline.vertices.length - 1].x = this.selectedSpline.maxx;

                for (var i = 0; i < this.selectedSpline.vertices.length; i++) {
                    this.selectedSpline.vertices[i].x = Math.max(Math.min(this.selectedSpline.vertices[i].x, this.selectedSpline.maxx), this.selectedSpline.minx);
                    this.selectedSpline.vertices[i].y = Math.max(Math.min(this.selectedSpline.vertices[i].y, this.selectedSpline.maxy), this.selectedSpline.miny).toFixed(this.selectedSpline.digits);
                }

                sortVertices();
                renderSelectedSpline();
            }

            function updateVertexForm() {
                this.selectedSpline.name = document.getElementById('splineName').value;
                this.selectedSpline.digits = document.getElementById('round').value;
                document.getElementById('newSplineSaveButton').disabled = this.selectedSpline.name.length < 3;
            }

            function renderSelectedSpline() {
                document.getElementById('splineName').value = this.selectedSpline.name;
                let vertexMarkup = `
                            <div class="row" >
                                <div class="col-5">
                                    <div class="form-group">
                                        <label>   X values</label>
                                    </div>
                                </div>
                                <div class="col-5">
                                    <div class="form-group">
                                        <label>   Y values</label>
                                    </div>
                                </div>
                                <div style="-ms-flex: 0 0 50px;flex: 0 0 50px; margin-right: 15px">
                                </div>
                            </div>
                `;
                chart.data.datasets[0].data = [];
                for (var i = 0; i < this.selectedSpline.vertices.length; i++) {
                    vertexMarkup += `
                    <div class="row">
                                <div class="col-5">
                                    <div class="form-group">
                                        <div class="input-group">
                                            <input type="number" class="form-control" ${(i == 0 || i + 1 == this.selectedSpline.vertices.length) ? 'disabled' : ''} value="${this.selectedSpline.vertices[i].x}" min="${this.selectedSpline.minx}" max="${this.selectedSpline.maxx}" onchange="changeVertexX(this.value, ${i})">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-5">
                                    <div class="form-group">
                                        <div class="input-group">
                                            <input type="number" class="form-control" value="${this.selectedSpline.vertices[i].y}" step="${1 / (Math.pow(10, this.selectedSpline.digits))}" min="${this.selectedSpline.miny}" max="${this.selectedSpline.maxy}" onchange="changeVertexY(this.value, ${i})">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-2">
                                    <div class="form-group">
                                        <button type="button" ${(i == 0 || i + 1 == this.selectedSpline.vertices.length) ? 'disabled' : ''} class="btn btn-secondary float-right" style="width: 42px !important; height: 42px !important" onclick="removeVertex(${i})">
                                            <span class="fa fa-trash"></span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                    `;

                    chart.data.datasets[0].data.push({ x: this.selectedSpline.vertices[i].x, y: this.selectedSpline.vertices[i].y });
                }
                document.getElementById('splineVertices').innerHTML = vertexMarkup;

                chart.options.scales.xAxes[0].ticks.min = this.selectedSpline.minx;
                chart.options.scales.xAxes[0].ticks.max = this.selectedSpline.maxx;
                chart.options.scales.yAxes[0].ticks.min = this.selectedSpline.miny;
                chart.options.scales.yAxes[0].ticks.max = this.selectedSpline.maxy;

                chart.options.scales.yAxes[0].ticks.stepSize = 1 / (Math.pow(10, this.selectedSpline.digits));

                chart.data.datasets[0].steppedLine = chart.options.scales.yAxes[0].ticks.stepSize == 1 ? 'middle' : false;

                chart.options.annotation.annotations[0].value = slider.getValue() / 100 * (this.selectedSpline.maxx - this.selectedSpline.minx);
                chart.options.annotation.annotations[0].borderColor = 'rgba(108, 117, 125,0.35)';
                chart.options.annotation.annotations[0].label.content = (slider.getValue() / 100 * (this.selectedSpline.maxx - this.selectedSpline.minx)).toFixed(2);

                let chartHeight = document.getElementById('chart').clientHeight;
                if (chartHeight == 0) {
                    chartHeight = 400;
                }
                var gradient = document.getElementById('chart').getContext('2d').createLinearGradient(0, 0, 0, chartHeight);
                gradient.addColorStop(1, 'rgba(0, 191, 255, 0)');
                gradient.addColorStop(0.25, 'rgba(0, 191, 255, 0.85)');
                chart.data.datasets[0].backgroundColor = gradient;

                document.getElementById('minx').value = this.selectedSpline.minx;
                document.getElementById('miny').value = this.selectedSpline.miny;
                document.getElementById('maxx').value = this.selectedSpline.maxx;
                document.getElementById('maxy').value = this.selectedSpline.maxy;
                document.getElementById('round').value = this.selectedSpline.digits;

                chart.update();
                document.getElementById('addVertexButton').disabled = this.selectedSpline.vertices.length > 30;
            }

            window.removeVertex = function (e) {
                this.selectedSpline.vertices.splice(e, 1);
                renderSelectedSpline();
            }

            window.changeVertexX = function (v, i) {
                this.selectedSpline.vertices[i].x = v;
                updateBoundaries();
            }

            window.changeVertexY = function (v, i) {
                this.selectedSpline.vertices[i].y = v;
                updateBoundaries();
            }

            // utils

            function liveTest(value) {
                Homey.api('POST', '/liveTest', { ...this.selectedSpline, value: value }, function (err, result) {
                    if (err || result.error) {
                        chart.options.annotation.annotations[0].borderColor = 'rgba(255, 0, 0,0.85)';
                        chart.update();
                    } else {
                        chart.options.annotation.annotations[0].borderColor = 'rgba(108, 117, 125,0.75)';
                        chart.options.annotation.annotations[0].label.content = value + "➞" + result.result;
                        chart.update();
                    }
                })
            }

            function generateGuid() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }

            function loadSplines() {
                if (Homey.isMock) {
                    splines = [];
                    splines.push({ id: '1', name: "sample spline 1", digits: 2, minx: 0, miny: 0, maxx: 10, maxy: 1, vertices: [{ x: 0, y: 0 }, { x: 2, y: 1 }, { x: 5, y: 0.1 }, { x: 10, y: 0.75 }] });
                    splines.push({ id: '2', name: "sample spline 2", digits: 2, minx: 0, miny: 0, maxx: 1, maxy: 1, vertices: [{ x: 0, y: 0 }, { x: 0.25, y: 1 }, { x: 0.75, y: 0.1 }, { x: 1, y: 0.75 }] });
                    splines.push({ id: '3', name: "sample spline 3", digits: 2, minx: 0, miny: 0, maxx: 1, maxy: 1, vertices: [{ x: 0, y: 0 }, { x: 0.25, y: 1 }, { x: 0.75, y: 0.1 }, { x: 1, y: 0.75 }] });
                    renderSplines();
                } else {
                    Homey.get('splines', (err, result) => {
                        if (err) return Homey.alert(err);
                        if (result) {
                            splines = result;
                        }
                        renderSplines();
                    })
                }
            }

            var chartOptions = {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            showLine: true,
                            borderColor: 'rgb(108, 117, 125)',
                            borderWidth: 3,
                            pointRadius: 5,
                            pointBackgroundColor: 'rgb(0,191,255)',
                            pointBorderColor: 'rgb(108, 117, 125)',
                            pointBorderWidth: 3,
                            pointHoverRadius: 10,
                            pointHoverBorderWidth: 3,
                            pointHoverBorderColor: 'rgb(108, 117, 125)',
                            pointHoverBackgroundColor: 'rgb(0,191,255)',
                            pointHitRadius: 25,
                            data: [],
                            cubicInterpolationMode: 'monotone',
                            lineTension: 0.5
                        }
                    ]
                },
                options: {
                    legend: {
                        display: false
                    },
                    scales: {
                        xAxes: [
                            {
                                id: 'xAxis',
                                ticks: {
                                    min: 0,
                                    max: 100
                                }
                            }
                        ],
                        yAxes: [
                            {
                                id: 'yAxis',
                                ticks: {
                                    min: 0,
                                    max: 100
                                }
                            }
                        ]
                    },
                    dragData: true,
                    dragX: true,
                    dragDataRound: 3,
                    dragOptions: {
                        showTooltip: true
                    },
                    annotation: {
                        annotations: [{
                            type: 'line',
                            mode: 'vertical',
                            scaleID: 'xAxis',
                            value: '0',
                            borderColor: 'rgba(108, 117, 125,0.75)',
                            borderWidth: 5,
                            label: {
                                enabled: true,
                                position: 'center',
                                content: ''
                            },
                            draggable: true,
                            onDrag: function (event) {
                                console.log(event.subject.config.value);
                            }
                        }]
                    },
                    onDragStart: function (e) {

                    },
                    onDrag: function (e, datasetIndex, index, value) {
                        e.target.style.cursor = 'grabbing'
                    },
                    hover: {
                        onHover: function (e) {
                            const point = this.getElementAtEvent(e)
                            if (point.length) e.target.style.cursor = 'grab'
                            else e.target.style.cursor = 'default'
                        }
                    },
                    onDragEnd: function (e, datasetIndex, index, value) {
                        e.target.style.cursor = 'default';
                        if (index == 0) {
                            value.x = this.selectedSpline.minx;
                        } else if (index == this.selectedSpline.vertices.length - 1) {
                            value.x = this.selectedSpline.maxx;
                        }
                        this.selectedSpline.vertices[index] = value;
                        updateBoundaries();
                    }
                }
            }

            let chart = new Chart(document.getElementById('chart').getContext('2d'), chartOptions);

            loadSplines();

            Homey.ready();
        }

    </script>
</body>

</html>